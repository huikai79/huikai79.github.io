name: Sync Notion â†’ Build â†’ Deploy â†’ Purge Cache

on:
push:
branches: [main]
workflow_dispatch:
schedule:
- cron: '0 */6 * * *'

permissions:
contents: write
pages:    write
id-token: write

concurrency:
group: "pages"
cancel-in-progress: true

jobs:
build:
runs-on: ubuntu-latest
steps:
- name: Checkout (with submodules)
uses: actions/checkout@v4
with:
submodules: recursive

- name: Setup Node.js  
    uses: actions/setup-node@v4  
    with:  
      node-version: 20  
  - name: Sync Notion database to content/posts  
    env:  
      NOTION_TOKEN:       ${{ secrets.NOTION_TOKEN }}  
      NOTION_DATABASE_ID: ${{ secrets.NOTION_PAGE_URL }}  
    run: |  
      npm install @notionhq/client notion-to-md  
      # === ä»¥ä¸‹æ˜¯å¢åŠ äº†è°ƒè¯•ä¿¡æ¯çš„æ–°ç‰ˆè„šæœ¬ ===  
      cat <<'EOF' | node -  
      const { Client } = require("@notionhq/client");  
      const { NotionToMarkdown } = require("notion-to-md");  
      const fs = require("fs/promises");  
      const path = require("path");  

      const notion = new Client({ auth: process.env.NOTION_TOKEN });  
      const n2m = new NotionToMarkdown({ notionClient: notion });  

      // --- è°ƒè¯•ä¿¡æ¯ ---  
      console.log("--- STARTING NOTION SYNC SCRIPT ---");  
      const databaseId = process.env.NOTION_DATABASE_ID;  
      if (!databaseId) {  
        console.error("âŒ ERROR: NOTION_DATABASE_ID secret is not set!");  
        process.exit(1);  
      }  
      console.log(`âœ… Using Database ID: ${databaseId}`);  
      // ----------------  

      const outputDir = "content/posts";  

      async function sync() {  
        await fs.rm(outputDir, { recursive: true, force: true });  
        await fs.mkdir(outputDir, { recursive: true });  

        console.log("STEP 1: Querying Notion database...");  
        const filter = { property: "status", select: { "equals": "Published" } };  
        console.log("ğŸ” Using filter:", JSON.stringify(filter, null, 2));  

        const response = await notion.databases.query({  
          database_id: databaseId,  
          filter: filter,  
        });  

        console.log(`STEP 2: Notion API call complete.`);  
        console.log(`âœ… Found ${response.results.length} pages that match the filter.`);  

        if (response.results.length === 0) {  
            console.warn("âš ï¸ WARNING: No pages with status 'Published' were found. The website will have no posts.");  
        }  

        console.log("STEP 3: Processing pages...");  
        for (const page of response.results) {  
          const title = page.properties.Title.title[0]?.plain_text || 'Untitled';  
          console.log(`  -> Processing page: "${title}" (ID: ${page.id})`);  

          const slug = page.properties.slug.rich_text[0]?.plain_text;  
          const date = page.properties.date.date?.start;  
          const tags = page.properties.tags.multi_select.map(tag => tag.name);  

          if (!slug) {  
            console.warn(`    SKIPPING page "${title}" because it has no slug.`);  
            continue;  
          }  
          const mdblocks = await n2m.pageToMarkdown(page.id);  
          const mdString = n2m.toMarkdownString(mdblocks);  
          const frontmatter = `---  
    title: "${title.replace(/"/g, '\\"')}"  
    date: ${date}  
    slug: "${slug}"  
    tags: [${tags.map(t => `"${t}"`).join(', ')}]  
    ---  
    `;  
          const finalContent = frontmatter + "\n" + mdString.parent;  
          const outputPath = path.join(outputDir, `${slug}.md`);  
          await fs.writeFile(outputPath, finalContent);  
          console.log(`    âœ… Successfully created ${outputPath}`);  
        }  
        console.log("--- NOTION SYNC SCRIPT FINISHED ---");  
      }  
      sync().catch(error => {  
          console.error("âŒ FATAL ERROR during sync:", error);  
          process.exit(1);  
      });  
      EOF  

  - name: Convert HEIC/HEIF images to JPEG  
    run: |  
      sudo apt-get update && sudo apt-get -y install imagemagick libheif-examples  
      find ./static -type f î€-iname '*.heic' -o -iname '*.heif'î€ -print0 |  
      while IFS= read -r -d '' f; do  
        echo "Converting $f"  
        convert "$f" "${f%.*}.jpeg"  
        rm "$f"  
      done  
      find ./content/posts -name '*.md' -exec sed -i 's/\.î€heic\|heifî€/.jpeg/gi' {} +  

  - name: Merge Blowfish theme overrides  
    run: cp -rT themes/blowfish/layouts/ layouts/ && cp -rT themes/blowfish/assets/  assets/  

  - name: Setup Hugo  
    uses: peaceiris/actions-hugo@v3.0.0  
    with:  
      hugo-version: 0.124.1  
      extended: true  

  - name: Build site  
    run: hugo --minify  

  - name: Upload build artifact  
    uses: actions/upload-pages-artifact@v3  
    with:


